<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeKernel Dashboard</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #2563eb;
      --border: #e5e7eb;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      margin: 0 0 8px;
    }

    h2 {
      margin: 16px 0 8px;
    }

    h3 {
      margin: 12px 0 8px;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .row.center {
      justify-content: center;
    }

    .tabs {
      display: inline-flex;
      gap: 8px;
      padding: 6px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: var(--shadow);
      margin-top: 16px;
    }

    .tab-button {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
    }

    .tab-button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .tab-panel {
      display: none;
      margin-top: 16px;
    }

    .tab-panel.active {
      display: block;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      background: var(--card);
      box-shadow: var(--shadow);
    }

    .section {
      margin-top: 20px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      margin-right: 6px;
      font-size: 12px;
      color: #3730a3;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .status-done {
      background: #d1fae5;
      color: #065f46;
    }

    .priority-low {
      background: #e5e7eb;
      color: #374151;
    }

    .priority-medium {
      background: #dbeafe;
      color: #1e40af;
    }

    .priority-high {
      background: #fee2e2;
      color: #991b1b;
    }

    .list {
      display: grid;
      gap: 12px;
    }

    .filter-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-end;
    }

    .filter-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .filter-field label {
      font-size: 12px;
      color: var(--muted);
    }

    .filter-field input,
    .filter-field select {
      width: 100%;
      min-width: 0;
    }

    .filter-text {
      flex: 2 1 320px;
    }

    .filter-date {
      flex: 1 1 180px;
    }

    .filter-select {
      flex: 0 1 160px;
    }

    .filter-quick {
      flex: 0 1 auto;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .error {
      color: #b00020;
    }

    .mono {
      font-family: Consolas, "Courier New", monospace;
      font-size: 12px;
    }

    .task-card {
      border-left: 4px solid transparent;
    }

    .task-priority-high {
      border-left-color: #ef4444;
    }

    .task-priority-medium {
      border-left-color: #3b82f6;
    }

    .task-priority-low {
      border-left-color: #9ca3af;
    }

    .task-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .task-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .stat-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .stat-card .value {
      font-size: 22px;
      font-weight: 700;
    }

    .stat-card .label {
      font-size: 12px;
      color: var(--muted);
    }

    .stat-accent-pending {
      color: #f59e0b;
    }

    .stat-accent-done {
      color: #10b981;
    }

    .stat-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #e5e7eb;
      margin-right: 8px;
    }

    .stat-icon.pending {
      background: #fde68a;
    }

    .stat-icon.done {
      background: #a7f3d0;
    }

    input[type=date],
    input[type=text],
    select {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--card);
      color: var(--text);
    }

    button {
      padding: 8px 12px;
      border: 0;
      border-radius: 8px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
    }

    button:hover {
      filter: brightness(0.95);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th,
    td {
      border-bottom: 1px solid var(--border);
      padding: 12px 10px;
      font-size: 12px;
      text-align: left;
    }

    th {
      background: #f3f4f6;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tbody tr:nth-child(even) {
      background: rgba(148, 163, 184, 0.08);
    }

    tbody tr:hover {
      background: rgba(59, 130, 246, 0.12);
    }

    .table-col-id {
      width: 140px;
    }

    .table-col-title {
      width: 50%;
    }

    .table-col-date {
      width: 110px;
    }

    .truncate {
      display: inline-block;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: bottom;
    }

    .warn {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 10px;
      border-radius: 8px;
    }

    .loading {
      color: var(--muted);
      font-size: 12px;
    }

    .filter-actions {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      align-items: center;
    }

    .filter-actions button {
      background: #e5e7eb;
      color: #111827;
      padding: 4px 12px;
      font-size: 12px;
      white-space: nowrap;
    }

    .filter-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .view-switch {
      display: inline-flex;
      gap: 0;
      padding: 3px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--card);
      box-shadow: var(--shadow);
    }

    .view-switch button {
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
    }

    .view-switch button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .view-panel {
      margin-top: 16px;
    }

    .filter-actions button.active {
      background: var(--primary);
      color: #fff;
    }
    .timeline {
      position: relative;
      margin-top: 12px;
    }

    .timeline::before {
      content: "";
      position: absolute;
      left: 89px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
      z-index: 0;
    }

    .timeline-date {
      margin: 16px 0 8px;
      font-weight: 700;
    }

    .timeline-item {
      display: grid;
      grid-template-columns: 70px 16px 1fr;
      gap: 12px;
      align-items: center;
      margin-bottom: 14px;
      position: relative;
      z-index: 1;
    }

    .timeline-item > :nth-child(3) {
      min-width: 0;
    }

    .timeline-time {
      font-size: 11px;
      color: var(--muted);
      text-align: right;
      padding-top: 0;
      align-self: center;
    }

    .timeline-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--primary);
      margin-top: 0;
      margin-left: 3px;
      position: relative;
      z-index: 2;
      box-shadow: 0 0 0 2px var(--bg);
    }

    .timeline-dot.module-work {
      background: #3b82f6;
    }

    .timeline-dot.module-personal {
      background: #f97316;
    }

    .timeline-dot.module-learning {
      background: #8b5cf6;
    }

    .timeline-dot.module-health {
      background: #10b981;
    }

    .timeline-card {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
    }

    .timeline-meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .meta-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
      display: inline-block;
    }

    .meta-dot.status-completed {
      background: #10b981;
    }

    .meta-dot.status-failed {
      background: #ef4444;
    }

    .meta-dot.status-pending {
      background: #f59e0b;
    }

    .date-separator {
      background: #f8fafc;
      font-weight: 700;
      color: #334155;
    }

    .log-paths {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      font-family: Consolas, "Courier New", monospace;
      white-space: pre-wrap;
      word-break: break-all;
      overflow-wrap: break-word;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --card: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --primary: #3b82f6;
        --border: #1f2937;
        --shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }

      th {
        background: #0b1220;
      }

      .warn {
        background: #3b2f1a;
        border-color: #5a4527;
      }

      input[type=date],
      input[type=text],
      select {
        background: #0b1220;
        color: #e5e7eb;
        border-color: #1f2937;
      }

      .filter-actions button {
        background: #1f2937;
        color: #e5e7eb;
      }

      .date-separator {
        background: #0b1220;
        color: #e5e7eb;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>LifeKernel Dashboard</h1>
    <div class="muted">Default loads tasks and lifelog. Task filters and log filters are independent.</div>

    <div id="corsNotice" class="section warn" style="display:none;"></div>

    <div id="status" class="section muted"></div>
    <div id="logLoading" class="section loading" style="display:none;"></div>

    <div class="tabs" role="tablist" aria-label="Dashboard Tabs">
      <button class="tab-button active" data-tab="tasks" role="tab" aria-selected="true">Tasks</button>
      <button class="tab-button" data-tab="logs" role="tab" aria-selected="false">Logs</button>
    </div>

    <div id="tab-tasks" class="tab-panel active" role="tabpanel">
      <div class="section">
        <h2>Tasks</h2>
        <div id="taskSummary" class="stat-bar"></div>
        <div class="section card">
          <h3>Filters</h3>
          <div class="filter-panel">
            <div class="filter-row">
              <div class="filter-field filter-text">
                <label for="taskNameFilter">Title/Keyword</label>
                <input type="text" id="taskNameFilter" placeholder="Task title" />
              </div>
              <div class="filter-field filter-date">
                <label for="taskDateStart">From</label>
                <input type="date" id="taskDateStart" />
              </div>
              <div class="filter-field filter-date">
                <label for="taskDateEnd">To</label>
                <input type="date" id="taskDateEnd" />
              </div>
              <div class="filter-field filter-quick">
                <label>Quick</label>
                <div class="filter-actions">
                  <button type="button" data-task-range="today">Today</button>
                  <button type="button" data-task-range="7">Last 7 Days</button>
                  <button type="button" data-task-range="30">Last 30 Days</button>
                </div>
              </div>
            </div>
            <div class="filter-row">
              <div class="filter-field filter-select">
                <label for="taskStatus">Status</label>
                <select id="taskStatus">
                  <option value="all">All</option>
                  <option value="pending">Pending</option>
                  <option value="done">Done</option>
                </select>
              </div>
              <div class="filter-field filter-select">
                <label for="taskPriority">Priority</label>
                <select id="taskPriority">
                  <option value="all">All</option>
                  <option value="low">low</option>
                  <option value="medium">medium</option>
                  <option value="high">high</option>
                </select>
              </div>
              <div class="filter-field filter-select">
                <label for="taskModule">Module</label>
                <select id="taskModule">
                  <option value="all">All</option>
                  <option value="work">work</option>
                  <option value="personal">personal</option>
                  <option value="learning">learning</option>
                  <option value="health">health</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="section">
          <h3>To-Do</h3>
          <div id="taskList" class="list"></div>
        </div>
        <div class="section">
          <h3>All History</h3>
          <div id="taskTable"></div>
          <div class="row center" style="margin-top:10px;">
            <button id="prevPage">Prev</button>
            <span id="pageInfo" class="muted"></span>
            <button id="nextPage">Next</button>
          </div>
        </div>
      </div>
    </div>

    <div id="tab-logs" class="tab-panel" role="tabpanel">
      <div class="section">
        <h2>Logs</h2>
        <div class="section card">
          <div class="filter-header">
            <h3>Filters</h3>
            <div class="view-switch" role="group" aria-label="Log view">
              <button type="button" class="view-button active" data-view="timeline">Timeline</button>
              <button type="button" class="view-button" data-view="table">List</button>
            </div>
          </div>
          <div class="filter-panel">
            <div class="filter-row">
              <div class="filter-field filter-text">
                <label for="logNameFilter">Keyword</label>
                <input type="text" id="logNameFilter" placeholder="Log description" />
              </div>
              <div class="filter-field filter-date">
                <label for="logDateStart">From</label>
                <input type="date" id="logDateStart" />
              </div>
              <div class="filter-field filter-date">
                <label for="logDateEnd">To</label>
                <input type="date" id="logDateEnd" />
              </div>
              <div class="filter-field filter-quick">
                <label>Quick</label>
                <div class="filter-actions">
                  <button type="button" data-range="today">Today</button>
                  <button type="button" data-range="7">Last 7 Days</button>
                  <button type="button" data-range="30">Last 30 Days</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="lifelogTablePanel" class="section view-panel">
          <div id="lifelogTable"></div>
        </div>
        <div id="lifelogListPanel" class="section view-panel">
          <div id="lifelogList" class="list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function parseJsonl(text) {
      return text.split(/\r?\n/).filter(Boolean).map(line => {
        try { return JSON.parse(line); } catch (e) { return { _parseError: true, raw: line }; }
      });
    }

    function extractDateOnly(value) {
      if (!value) return null;
      if (typeof value === 'string') {
        const m = value.match(/^(\d{4}-\d{2}-\d{2})/);
        if (m) return m[1];
      }
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return null;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function inDateRange(iso, start, end) {
      if (!start && !end) return true;
      const d = extractDateOnly(iso);
      if (!d) return false;
      if (start && d < start) return false;
      if (end && d > end) return false;
      return true;
    }

    function parseDateInput(value) {
      if (!value) return null;
      const m = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const y = Number(m[1]);
      const mo = Number(m[2]) - 1;
      const d = Number(m[3]);
      const dt = new Date(Date.UTC(y, mo, d));
      return Number.isNaN(dt.getTime()) ? null : dt;
    }

    function formatDateUTC(date) {
      const yyyy = date.getUTCFullYear();
      const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
      const dd = String(date.getUTCDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function statusBadge(status) {
      const s = status || 'pending';
      const cls = s === 'done' ? 'status-done' : 'status-pending';
      return `<span class=\"badge ${cls}\">${s}</span>`;
    }

    function priorityBadge(priority) {
      const p = priority || 'medium';
      const cls = p === 'high' ? 'priority-high' : (p === 'low' ? 'priority-low' : 'priority-medium');
      return `<span class=\"badge ${cls}\">${p}</span>`;
    }

    let currentPage = 1;
    const pageSize = 10;

    function paginate(items) {
      const total = items.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
      return items.slice(start, end);
    }

    function formatDateShort(value) {
      if (!value) return '';
      if (typeof value === 'string') {
        const datePart = value.split('T')[0];
        return datePart || value;
      }
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return '';
      return extractDateOnly(d);
    }

    function formatTimeShort(value) {
      if (!value) return '';
      if (typeof value === 'string') {
        const match = value.match(/T(\\d{2}:\\d{2})/);
        if (match) return match[1];
      }
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return '';
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      return `${hh}:${mm}`;
    }

    function groupByDate(entries) {
      const grouped = [];
      let lastDate = null;
      for (const e of entries) {
        const date = formatDateShort(e.timestamp || '');
        if (date && date !== lastDate) {
          grouped.push({ _dateHeader: date });
          lastDate = date;
        }
        grouped.push(e);
      }
      return grouped;
    }

    function renderTasks(tasks) {
      const pending = tasks.filter(t => t.status !== 'done');
      pending.sort((a, b) => (a.due_time || '').localeCompare(b.due_time || ''));
      const done = tasks.filter(t => t.status === 'done');

      const summary = document.getElementById('taskSummary');
      summary.innerHTML = '';
      summary.appendChild(makeStatCard('Total', String(tasks.length), ''));
      summary.appendChild(makeStatCard('Pending', String(pending.length), 'stat-accent-pending'));
      summary.appendChild(makeStatCard('Done', String(done.length), 'stat-accent-done'));

      const list = document.getElementById('taskList');
      list.innerHTML = '';
      if (pending.length === 0) {
        list.innerHTML = '<div class=\"card muted\">All caught up!</div>';
      } else {
        for (const t of pending) {
          const el = document.createElement('div');
          const priority = String(t.priority || 'medium').toLowerCase();
          const priorityClass = ['low', 'medium', 'high'].includes(priority) ? `task-priority-${priority}` : 'task-priority-medium';
          el.className = `card task-card ${priorityClass}`;
          el.innerHTML = `
            <div class=\"task-title\">${t.title || ''}</div>
            <div class=\"task-meta\">
              <span class=\"pill\">${t.module || 'work'}</span>
              <span>Status ${statusBadge(t.status)} | Priority ${priorityBadge(t.priority)} | Due <span class=\"mono\">${formatDateShort(t.due_time) || '-'}</span></span>
            </div>
            <div>${t.details || ''}</div>
          `;
          list.appendChild(el);
        }
      }

      const paged = paginate(tasks);
      renderTaskTable(paged);
    }

    function renderTaskTable(tasks) {
      const table = [
        '<table>',
        '<thead><tr><th class=\"table-col-id\">ID</th><th class=\"table-col-title\">Title</th><th>Status</th><th>Priority</th><th>Module</th><th class=\"table-col-date\">Created</th><th class=\"table-col-date\">Completed</th><th class=\"table-col-date\">Due</th></tr></thead>',
        '<tbody>'
      ];
      for (const t of tasks) {
        const idText = t.id || '';
        table.push(`<tr><td><span class=\"mono truncate\" title=\"${idText}\">${idText}</span></td><td>${t.title || ''}</td><td>${statusBadge(t.status)}</td><td>${priorityBadge(t.priority)}</td><td>${t.module || ''}</td><td><span class=\"mono\">${formatDateShort(t.created_at)}</span></td><td><span class=\"mono\">${formatDateShort(t.completed_at)}</span></td><td><span class=\"mono\">${formatDateShort(t.due_time)}</span></td></tr>`);
      }
      table.push('</tbody></table>');
      document.getElementById('taskTable').innerHTML = table.join('');
    }

    function renderLifelog(entries) {
      const list = document.getElementById('lifelogList');
      list.innerHTML = '';
      if (entries.length === 0) {
        list.innerHTML = '<div class=\"card muted\">No log entries found.</div>';
      } else {
        const timeline = document.createElement('div');
        timeline.className = 'timeline';
        const grouped = groupByDate(entries.filter(e => !e._parseError));
        for (const e of grouped) {
          if (e._dateHeader) {
            const header = document.createElement('div');
            header.className = 'timeline-date';
            header.textContent = e._dateHeader;
            timeline.appendChild(header);
            continue;
          }
          const item = document.createElement('div');
          item.className = 'timeline-item';
          const status = String(e.status || 'completed').toLowerCase();
          const statusClass = status === 'failed' ? 'status-failed' : (status === 'pending' ? 'status-pending' : 'status-completed');
          const time = formatTimeShort(e.timestamp || '');
          const files = (e.related_files || []).join(', ');
          const module = String(e.module || 'work').toLowerCase();
          const moduleClass = `module-${module}`;
          item.innerHTML = `
            <div class=\"timeline-time mono\">${time || ''}</div>
            <div class=\"timeline-dot ${moduleClass}\"></div>
            <div class=\"timeline-card\">
              <div>${e.description || ''}</div>
              <div class=\"timeline-meta\">
                <span class=\"meta-dot ${statusClass}\"></span>
                <span>${e.module || 'work'}</span>
                <span>${e.status || ''}</span>
              </div>
              ${files ? `<div class=\"log-paths\">${files}</div>` : ''}
            </div>
          `;
          timeline.appendChild(item);
        }
        list.appendChild(timeline);
      }
      renderLifelogTable(entries.filter(e => !e._parseError));
    }

    function renderLifelogTable(entries) {
      const table = [
        '<table>',
        '<thead><tr><th class=\"table-col-date\">Time</th><th>Description</th></tr></thead>',
        '<tbody>'
      ];
      const grouped = groupByDate(entries);
      for (const e of grouped) {
        if (e._dateHeader) {
          table.push(`<tr class=\"date-separator\"><td colspan=\"2\">${e._dateHeader}</td></tr>`);
          continue;
        }
        const desc = e.description || e.raw || '';
        const files = (e.related_files || []).join(', ');
        const time = formatTimeShort(e.timestamp || '');
        const module = e.module || '';
        const status = e.status || '';
        const meta = module || status ? `<div class=\"timeline-meta\"><span class=\"meta-dot\"></span><span>${module}</span><span>${status}</span></div>` : '';
        table.push(`<tr><td><span class=\"mono\">${time}</span></td><td>${desc}${meta}${files ? `<div class=\"log-paths\">${files}</div>` : ''}</td></tr>`);
      }
      table.push('</tbody></table>');
      document.getElementById('lifelogTable').innerHTML = table.join('');
    }

    function makeCard(title, value) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `<div class=\"muted\">${title}</div><div style=\"font-size:20px;\">${value}</div>`;
      return el;
    }

    function makeStatCard(title, value, accentClass) {
      const el = document.createElement('div');
      el.className = 'card stat-card';
      const accent = accentClass ? ` ${accentClass}` : '';
      const iconClass = title.toLowerCase().includes('pending') ? 'pending' : (title.toLowerCase().includes('done') ? 'done' : '');
      el.innerHTML = `<div class=\"label\"><span class=\"stat-icon ${iconClass}\"></span>${title}</div><div class=\"value${accent}\">${value}</div>`;
      return el;
    }

    const statusEl = document.getElementById('status');
    const logLoadingEl = document.getElementById('logLoading');
    let allTasks = [];
    let allLifelog = [];
    let lifelogRangeKey = null;
    let lifelogSource = null;
    let lifelogBase = null;
    let lifelogFileIndex = null;

    function setLogLoading(isLoading, message) {
      if (logLoadingEl) {
        logLoadingEl.style.display = isLoading ? 'block' : 'none';
        logLoadingEl.textContent = message || '';
      }
      const startInput = document.getElementById('logDateStart');
      const endInput = document.getElementById('logDateEnd');
      if (startInput) startInput.disabled = isLoading;
      if (endInput) endInput.disabled = isLoading;
    }

    function applyTaskFilters() {
      const start = document.getElementById('taskDateStart').value || null;
      const end = document.getElementById('taskDateEnd').value || null;
      const name = (document.getElementById('taskNameFilter').value || '').trim().toLowerCase();
      const taskStatus = document.getElementById('taskStatus').value;
      const taskPriority = document.getElementById('taskPriority').value;
      const taskModule = document.getElementById('taskModule').value;

      const tasks = allTasks.filter(t => {
        const dateField = t.due_time || t.created_at || '';
        const inRange = inDateRange(dateField, start, end);
        const inName = !name || String(t.title || '').toLowerCase().includes(name);
        const inStatus = taskStatus === 'all' || t.status === taskStatus;
        const inPriority = taskPriority === 'all' || t.priority === taskPriority;
        const inModule = taskModule === 'all' || t.module === taskModule;
        return inRange && inName && inStatus && inPriority && inModule;
      });

      renderTasks(tasks);
    }

    function applyLogFilters() {
      const start = document.getElementById('logDateStart').value || null;
      const end = document.getElementById('logDateEnd').value || null;
      const name = (document.getElementById('logNameFilter').value || '').trim().toLowerCase();

      const logs = allLifelog.filter(e => {
        if (e._parseError) return false;
        const inRange = inDateRange(e.timestamp || '', start, end);
        const inName = !name || String(e.description || '').toLowerCase().includes(name);
        return inRange && inName;
      });
      logs.sort((a, b) => {
        const ta = Date.parse(a.timestamp || '') || 0;
        const tb = Date.parse(b.timestamp || '') || 0;
        return tb - ta;
      });

      renderLifelog(logs);
    }

    async function fetchFirst(paths) {
      let lastError = null;
      for (const p of paths) {
        try {
          const res = await fetch(p);
          if (res.ok) return { res, path: p };
        } catch (e) {
          lastError = e;
        }
      }
      throw lastError || new Error('all fetch attempts failed');
    }

    async function loadTasks() {
      try {
        const candidates = ['../tasks/tasks.jsonl', './tasks/tasks.jsonl', '/tasks/tasks.jsonl'];
        const result = await fetchFirst(candidates);
        const text = await result.res.text();
        allTasks = parseJsonl(text);
        applyTaskFilters();
        statusEl.textContent = `Loaded tasks: ${result.path.replace(/^\//, '')}`;
      } catch (e) {
        statusEl.textContent = 'Cannot read tasks.jsonl. Use Live Preview with access to workspace files.';
      }
    }

    function normalizeListingHref(href) {
      if (!href) return '';
      let clean = href.split('?')[0].split('#')[0];
      try {
        clean = decodeURIComponent(clean);
      } catch (e) {
        // ignore decode errors
      }
      clean = clean.replace(/\\/g, '/');
      if (clean.startsWith('/')) clean = clean.slice(1);
      const idx = clean.indexOf('lifelog/');
      if (idx >= 0) clean = clean.slice(idx + 'lifelog/'.length);
      return clean;
    }

    function extractListingHrefs(html) {
      const hrefs = Array.from(html.matchAll(/href="([^"]+)"/g)).map(m => m[1]);
      if (hrefs.length > 0) return hrefs;
      const single = Array.from(html.matchAll(/href='([^']+)'/g)).map(m => m[1]);
      if (single.length > 0) return single;
      const dataHrefs = Array.from(html.matchAll(/data-href="([^"]+)"/g)).map(m => m[1]);
      if (dataHrefs.length > 0) return dataHrefs;
      const paths = Array.from(html.matchAll(/\/workspace\/lifelog\/(\d{4}\/\d{2}\/\d{2}\.jsonl)/g)).map(m => m[1]);
      if (paths.length > 0) return paths;
      return [];
    }

    function normalizeDirToken(value, length) {
      if (!value) return '';
      const token = value.endsWith('/') ? value.slice(0, -1) : value;
      if (token.length !== length) return '';
      return `${token}/`;
    }

    function getLifelogBases() {
      const path = location.pathname || '';
      const root = path.includes('/workspace/') ? '/workspace/' : '/';
      return [`${root}lifelog/`, '../lifelog/'];
    }

    async function tryListFilesFromDirectory() {
      const bases = getLifelogBases();
      for (const base of bases) {
        const res = await fetch(base);
        if (!res.ok) continue;
        const html = await res.text();
        const hrefs = extractListingHrefs(html);
        const items = hrefs.map(normalizeListingHref).filter(Boolean);
        const directFiles = items.filter(h => h.endsWith('.jsonl'));
        const yearDirs = items.map(h => normalizeDirToken(h, 4)).filter(Boolean);
        if (directFiles.length > 0) {
          const filtered = directFiles.filter(f => f.split('/').length >= 3);
          if (filtered.length > 0) return { base, files: filtered };
        }
        if (yearDirs.length > 0) {
          const files = [];
          for (const year of yearDirs) {
            const yearRes = await fetch(`${base}${year}`);
            if (!yearRes.ok) continue;
            const yearHtml = await yearRes.text();
            const yearItems = extractListingHrefs(yearHtml).map(normalizeListingHref).filter(Boolean);
            const monthDirs = yearItems.map(h => {
              let value = h;
              if (value.startsWith(year)) value = value.slice(year.length);
              if (value.startsWith('/')) value = value.slice(1);
              return normalizeDirToken(value, 2);
            }).filter(Boolean);
            if (monthDirs.length === 0) {
              const yearFiles = yearItems.filter(h => h.endsWith('.jsonl'));
              for (const file of yearFiles) {
                const name = file.includes('/') ? file.split('/').pop() : file;
                if (name) files.push(`${year}${name}`);
              }
            }
            for (const month of monthDirs) {
              const monthRes = await fetch(`${base}${year}${month}`);
              if (!monthRes.ok) continue;
              const monthHtml = await monthRes.text();
              const monthItems = extractListingHrefs(monthHtml).map(normalizeListingHref).filter(Boolean);
              const monthFiles = monthItems.filter(h => h.endsWith('.jsonl'));
              for (const file of monthFiles) {
                const name = file.includes('/') ? file.split('/').pop() : file;
                if (name) files.push(`${year}${month}${name}`);
              }
            }
          }
          if (files.length > 0) return { base, files };
        }
      }
      throw new Error('no directory listing');
    }

    async function getLifelogFileIndex() {
      if (Array.isArray(lifelogFileIndex)) return lifelogFileIndex;
      try {
        const result = await tryListFilesFromDirectory();
        lifelogBase = result.base;
        lifelogFileIndex = result.files || [];
        return lifelogFileIndex;
      } catch (e) {
        lifelogFileIndex = null;
        return null;
      }
    }

    async function loadLifelogByFiles(files, base) {
      const baseDir = base || lifelogBase || '../lifelog/';
      if (!files || files.length === 0) {
        allLifelog = [];
        applyLogFilters();
        statusEl.textContent = 'No lifelog files found.';
        return;
      }
      setLogLoading(true, `Loading... 0/${files.length}`);
      const texts = [];
      const batchSize = 20;
      try {
        for (let i = 0; i < files.length; i += batchSize) {
          const batch = files.slice(i, i + batchSize);
          const results = await Promise.all(batch.map(f => fetch(`${baseDir}${f}`).then(r => r.ok ? r.text() : '')));
          texts.push(...results);
          const done = Math.min(i + batchSize, files.length);
          setLogLoading(true, `Loading... ${done}/${files.length}`);
        }
        allLifelog = texts.flatMap(t => t ? parseJsonl(t) : []);
        applyLogFilters();
        statusEl.textContent = `Loaded lifelog: ${allLifelog.length} entries`;
      } catch (e) {
        allLifelog = [];
        applyLogFilters();
        statusEl.textContent = 'Failed to load lifelog.';
      } finally {
        setLogLoading(false, '');
      }
    }

    async function resolveLifelogBaseByProbe(file) {
      const bases = getLifelogBases();
      for (const base of bases) {
        try {
          const res = await fetch(`${base}${file}`);
          if (res.ok || res.status === 404) return base;
        } catch (e) {
          // ignore and continue
        }
      }
      return '../lifelog/';
    }

    async function loadLifelogByRange(start, end) {
      if (!start || !end) return;
      const startDate = parseDateInput(start);
      const endDate = parseDateInput(end);
      if (!startDate || !endDate) return;
      const files = [];
      for (let d = new Date(startDate); d <= endDate; d.setUTCDate(d.getUTCDate() + 1)) {
        files.push(`${formatDateUTC(d).replace(/-/g, '/')}.jsonl`);
      }
      const index = await getLifelogFileIndex();
      if (index && index.length) {
        const set = new Set(index);
        const filtered = files.filter(f => set.has(f));
        await loadLifelogByFiles(filtered, lifelogBase || await resolveLifelogBaseByProbe(files[0]));
        return;
      }
      const base = lifelogBase || await resolveLifelogBaseByProbe(files[0]);
      lifelogBase = base;
      await loadLifelogByFiles(files, base);
    }

    async function loadAllLifelog() {
      try {
        const files = await getLifelogFileIndex();
        if (files && files.length > 0) {
          await loadLifelogByFiles(files, lifelogBase);
          lifelogSource = 'listing';
          lifelogRangeKey = null;
          return;
        }
        throw new Error('no files from listing');
      } catch (e) {
        allLifelog = [];
        applyLogFilters();
        statusEl.textContent = 'Cannot list lifelog files. Use date range to load.';
        const start = document.getElementById('logDateStart').value || null;
        const end = document.getElementById('logDateEnd').value || null;
        if (start && end) {
          await loadLifelogByRange(start, end);
          lifelogSource = 'range';
          lifelogRangeKey = `${start}..${end}`;
        }
      }
    }

    async function ensureLifelogLoaded(start, end) {
      if (start && end) {
        const key = `${start}..${end}`;
        if (lifelogSource !== 'range' || lifelogRangeKey !== key) {
          lifelogRangeKey = key;
          lifelogSource = 'range';
          await loadLifelogByRange(start, end);
        }
        return;
      }
      if (!allLifelog.length || lifelogSource !== 'listing') {
        await loadAllLifelog();
      }
    }

    function debounce(fn, delay) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    }

    function setActiveButton(buttons, active) {
      buttons.forEach(btn => btn.classList.toggle('active', btn === active));
    }

    function clearActiveButtons(buttons) {
      buttons.forEach(btn => btn.classList.remove('active'));
    }

    const debouncedTaskFilter = debounce(() => {
      currentPage = 1;
      applyTaskFilters();
    }, 300);

    const debouncedLogFilter = debounce(async () => {
      const start = document.getElementById('logDateStart').value || null;
      const end = document.getElementById('logDateEnd').value || null;
      await ensureLifelogLoaded(start, end);
      applyLogFilters();
    }, 300);

    document.getElementById('taskNameFilter').addEventListener('input', debouncedTaskFilter);
    document.getElementById('taskStatus').addEventListener('change', () => { currentPage = 1; applyTaskFilters(); });
    document.getElementById('taskPriority').addEventListener('change', () => { currentPage = 1; applyTaskFilters(); });
    document.getElementById('taskModule').addEventListener('change', () => { currentPage = 1; applyTaskFilters(); });
    document.getElementById('taskDateStart').addEventListener('change', () => { clearActiveButtons(taskQuickButtons); currentPage = 1; applyTaskFilters(); });
    document.getElementById('taskDateEnd').addEventListener('change', () => { clearActiveButtons(taskQuickButtons); currentPage = 1; applyTaskFilters(); });

    document.getElementById('logNameFilter').addEventListener('input', debouncedLogFilter);
    document.getElementById('logDateStart').addEventListener('change', async () => {
      clearActiveButtons(logQuickButtons);
      const start = document.getElementById('logDateStart').value || null;
      const end = document.getElementById('logDateEnd').value || null;
      if (start && end) {
        lifelogRangeKey = `${start}..${end}`;
        lifelogSource = 'range';
        await loadLifelogByRange(start, end);
      }
      applyLogFilters();
    });
    document.getElementById('logDateEnd').addEventListener('change', async () => {
      clearActiveButtons(logQuickButtons);
      const start = document.getElementById('logDateStart').value || null;
      const end = document.getElementById('logDateEnd').value || null;
      if (start && end) {
        lifelogRangeKey = `${start}..${end}`;
        lifelogSource = 'range';
        await loadLifelogByRange(start, end);
      }
      applyLogFilters();
    });

    function setLogRangeDays(days) {
      const today = new Date();
      const end = formatDateUTC(today);
      const startDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
      if (days > 0) {
        startDate.setUTCDate(startDate.getUTCDate() - (days - 1));
      }
      const start = formatDateUTC(startDate);
      const startInput = document.getElementById('logDateStart');
      const endInput = document.getElementById('logDateEnd');
      if (startInput) startInput.value = start;
      if (endInput) endInput.value = end;
    }

    function setTaskRangeDays(days) {
      const today = new Date();
      const end = formatDateUTC(today);
      const startDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
      if (days > 0) {
        startDate.setUTCDate(startDate.getUTCDate() - (days - 1));
      }
      const start = formatDateUTC(startDate);
      const startInput = document.getElementById('taskDateStart');
      const endInput = document.getElementById('taskDateEnd');
      if (startInput) startInput.value = start;
      if (endInput) endInput.value = end;
    }

    const logQuickButtons = Array.from(document.querySelectorAll('[data-range]'));
    const taskQuickButtons = Array.from(document.querySelectorAll('[data-task-range]'));

    logQuickButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        setActiveButton(logQuickButtons, btn);
        const val = btn.getAttribute('data-range');
        if (val === 'today') {
          setLogRangeDays(1);
        } else {
          const days = Number(val);
          if (!Number.isNaN(days)) setLogRangeDays(days);
        }
        const start = document.getElementById('logDateStart').value || null;
        const end = document.getElementById('logDateEnd').value || null;
        if (start && end) {
          lifelogRangeKey = `${start}..${end}`;
          lifelogSource = 'range';
          await loadLifelogByRange(start, end);
        }
        applyLogFilters();
      });
    });

    taskQuickButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        setActiveButton(taskQuickButtons, btn);
        const val = btn.getAttribute('data-task-range');
        if (val === 'today') {
          setTaskRangeDays(1);
        } else {
          const days = Number(val);
          if (!Number.isNaN(days)) setTaskRangeDays(days);
        }
        currentPage = 1;
        applyTaskFilters();
      });
    });

    document.getElementById('prevPage').addEventListener('click', () => {
      currentPage = Math.max(1, currentPage - 1);
      applyTaskFilters();
    });
    document.getElementById('nextPage').addEventListener('click', () => {
      currentPage += 1;
      applyTaskFilters();
    });

    const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
    const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));
    function activateTab(name) {
      tabButtons.forEach(btn => {
        const isActive = btn.dataset.tab === name;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      tabPanels.forEach(panel => {
        panel.classList.toggle('active', panel.id === `tab-${name}`);
      });
    }
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => activateTab(btn.dataset.tab));
    });

    let lifelogView = 'timeline';
    const viewButtons = Array.from(document.querySelectorAll('.view-button'));
    const lifelogTablePanel = document.getElementById('lifelogTablePanel');
    const lifelogListPanel = document.getElementById('lifelogListPanel');
    function setLifelogView(view) {
      lifelogView = view;
      viewButtons.forEach(btn => {
        const isActive = btn.dataset.view === view;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      if (lifelogTablePanel) lifelogTablePanel.style.display = view === 'table' ? 'block' : 'none';
      if (lifelogListPanel) lifelogListPanel.style.display = view === 'timeline' ? 'block' : 'none';
    }
    viewButtons.forEach(btn => {
      btn.addEventListener('click', () => setLifelogView(btn.dataset.view));
    });
    setLifelogView('timeline');

    const notice = document.getElementById('corsNotice');
    if (location.protocol === 'file:') {
      notice.style.display = 'block';
      notice.innerHTML = 'Detected file:// access. Use Live Preview via http:// to load local files.';
    }

    function initLogDefaults() {
      const today = new Date();
      const end = formatDateUTC(today);
      const startDate = new Date(Date.UTC(today.getUTCFullYear() - 1, today.getUTCMonth(), today.getUTCDate()));
      const start = formatDateUTC(startDate);
      const startInput = document.getElementById('logDateStart');
      const endInput = document.getElementById('logDateEnd');
      if (startInput && !startInput.value) startInput.value = start;
      if (endInput && !endInput.value) endInput.value = end;
      return { start, end };
    }

    loadTasks();
    const { start: defaultStart, end: defaultEnd } = initLogDefaults();
    lifelogRangeKey = `${defaultStart}..${defaultEnd}`;
    lifelogSource = 'range';
    loadLifelogByRange(defaultStart, defaultEnd);
  </script>
</body>

</html>
