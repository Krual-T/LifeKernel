<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeKernel Pulse</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #2563eb;
      --border: #e5e7eb;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 8px; }
    h2 { margin: 16px 0 8px; }
    h3 { margin: 12px 0 8px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: var(--card); box-shadow: var(--shadow); }
    .section { margin-top: 20px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; margin-right: 6px; font-size: 12px; color: #3730a3; }
    .list { display: grid; gap: 12px; }
    .muted { color: var(--muted); font-size: 12px; }
    .error { color: #b00020; }
    input[type=date], input[type=text], select { padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; }
    button { padding: 8px 12px; border: 0; border-radius: 8px; background: var(--primary); color: #fff; cursor: pointer; }
    button:hover { filter: brightness(0.95); }
    table { border-collapse: collapse; width: 100%; background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 10px; font-size: 12px; text-align: left; }
    th { background: #f3f4f6; }
    .warn { background: #fff3cd; border: 1px solid #ffeeba; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container">
  <h1>LifeKernel Pulse</h1>
    <div class="muted">自动读取 workspace/tasks/tasks.jsonl 与当日 lifelog，支持日期与名称筛选。</div>

    <div id="corsNotice" class="section warn" style="display:none;"></div>

    <div class="section card">
      <div class="row">
        <div class="muted">任务文件（workspace/tasks/tasks.jsonl）</div>
        <div class="muted">Lifelog 文件（workspace/lifelog/YYYY/MM/DD.jsonl）</div>
      </div>
      <div class="row" style="margin-top:12px;">
        <label for="lifelogDate">Lifelog 日期：</label>
        <input type="date" id="lifelogDate" />
        <button id="loadLifelogBtn">加载 Lifelog</button>
      </div>
    </div>

    <div class="section card">
      <h2>筛选</h2>
    <div class="row">
      <label>日期从：</label>
      <input type="date" id="dateStart" />
      <label>到：</label>
      <input type="date" id="dateEnd" />
      <label>名称/关键词：</label>
      <input type="text" id="nameFilter" placeholder="任务标题或 lifelog 描述" />
      <label>任务状态：</label>
      <select id="taskStatus">
        <option value="all">全部</option>
        <option value="pending">未完成</option>
        <option value="done">已完成</option>
      </select>
      <label>优先级：</label>
      <select id="taskPriority">
        <option value="all">全部</option>
        <option value="low">low</option>
        <option value="medium">medium</option>
        <option value="high">high</option>
      </select>
      <label>模块：</label>
      <select id="taskModule">
        <option value="all">全部</option>
        <option value="work">work</option>
        <option value="personal">personal</option>
        <option value="learning">learning</option>
        <option value="health">health</option>
      </select>
      <button id="applyFilter">应用筛选</button>
    </div>
  </div>

    <div id="status" class="section muted"></div>

    <div class="section">
      <h2>任务概览</h2>
      <div id="taskSummary" class="row"></div>
      <div class="section">
        <h3>未完成任务（卡片）</h3>
        <div id="taskList" class="list"></div>
      </div>
      <div class="section">
      <h3>任务表格（含已完成）</h3>
      <div id="taskTable"></div>
      <div class="row" style="margin-top:10px;">
        <button id="prevPage">上一页</button>
        <span id="pageInfo" class="muted"></span>
        <button id="nextPage">下一页</button>
      </div>
    </div>
  </div>

    <div class="section">
      <h2>Lifelog（表格）</h2>
      <div id="lifelogTable"></div>
      <div class="section">
        <h3>明细</h3>
        <div id="lifelogList" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    function parseJsonl(text) {
      return text.split(/\r?\n/).filter(Boolean).map(line => {
        try { return JSON.parse(line); } catch (e) { return { _parseError: true, raw: line }; }
      });
    }

    function toDateOnly(value) {
      if (!value) return null;
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return null;
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }

    function inDateRange(iso, start, end) {
      if (!start && !end) return true;
      const d = toDateOnly(iso);
      if (!d) return false;
      if (start && d < start) return false;
      if (end && d > end) return false;
      return true;
    }

    let currentPage = 1;
    const pageSize = 10;

    function paginate(items) {
      const total = items.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      document.getElementById('pageInfo').textContent = `第 ${currentPage} / ${totalPages} 页`;
      return items.slice(start, end);
    }

    function renderTasks(tasks) {
      const pending = tasks.filter(t => t.status !== 'done');
      pending.sort((a, b) => (a.due_time || '').localeCompare(b.due_time || ''));
      const done = tasks.filter(t => t.status === 'done');

      const summary = document.getElementById('taskSummary');
      summary.innerHTML = '';
      summary.appendChild(makeCard('总数', String(tasks.length)));
      summary.appendChild(makeCard('未完成', String(pending.length)));
      summary.appendChild(makeCard('已完成', String(done.length)));

      const list = document.getElementById('taskList');
      list.innerHTML = '';
      if (pending.length === 0) {
        list.innerHTML = '<div class="muted">暂无未完成任务</div>';
      } else {
        for (const t of pending) {
          const el = document.createElement('div');
          el.className = 'card';
          el.innerHTML = `
            <div><strong>[${t.module || 'work'}]</strong> ${t.title || ''}</div>
            <div class="muted">Status: ${t.status || 'pending'} | Priority: ${t.priority || 'medium'} | Due: ${t.due_time || '-'}</div>
            <div>${t.details || ''}</div>
          `;
          list.appendChild(el);
        }
      }

      const paged = paginate(tasks);
      renderTaskTable(paged);
    }

    function renderTaskTable(tasks) {
      const table = [
        '<table>',
        '<thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Module</th><th>Created</th><th>Completed</th><th>Due</th></tr></thead>',
        '<tbody>'
      ];
      for (const t of tasks) {
        table.push(`<tr><td>${t.id || ''}</td><td>${t.title || ''}</td><td>${t.status || ''}</td><td>${t.priority || ''}</td><td>${t.module || ''}</td><td>${t.created_at || ''}</td><td>${t.completed_at || ''}</td><td>${t.due_time || ''}</td></tr>`);
      }
      table.push('</tbody></table>');
      document.getElementById('taskTable').innerHTML = table.join('');
    }

    function renderLifelog(entries) {
      const list = document.getElementById('lifelogList');
      list.innerHTML = '';
      if (entries.length === 0) {
        list.innerHTML = '<div class="muted">暂无 lifelog</div>';
      } else {
        for (const e of entries) {
          const el = document.createElement('div');
          el.className = 'card';
          if (e._parseError) {
            el.innerHTML = `<div class="error">解析失败：${e.raw}</div>`;
          } else {
            el.innerHTML = `
              <div><strong>${e.timestamp || ''}</strong> <span class="pill">${e.module || 'work'}</span> <span class="pill">${e.status || ''}</span></div>
              <div>${e.description || ''}</div>
              <div class="muted">${(e.related_files || []).join(', ')}</div>
            `;
          }
          list.appendChild(el);
        }
      }
      renderLifelogTable(entries.filter(e => !e._parseError));
    }

    function renderLifelogTable(entries) {
      const table = [
        '<table>',
        '<thead><tr><th>Time</th><th>Module</th><th>Status</th><th>Description</th></tr></thead>',
        '<tbody>'
      ];
      for (const e of entries) {
        table.push(`<tr><td>${e.timestamp || ''}</td><td>${e.module || ''}</td><td>${e.status || ''}</td><td>${e.description || ''}</td></tr>`);
      }
      table.push('</tbody></table>');
      document.getElementById('lifelogTable').innerHTML = table.join('');
    }

    function makeCard(title, value) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `<div class="muted">${title}</div><div style="font-size:20px;">${value}</div>`;
      return el;
    }

    const statusEl = document.getElementById('status');
    let allTasks = [];
    let allLifelog = [];

    function applyFilters() {
      const start = toDateOnly(document.getElementById('dateStart').value);
      const end = toDateOnly(document.getElementById('dateEnd').value);
      const name = (document.getElementById('nameFilter').value || '').trim().toLowerCase();
      const taskStatus = document.getElementById('taskStatus').value;
      const taskPriority = document.getElementById('taskPriority').value;
      const taskModule = document.getElementById('taskModule').value;

      const tasks = allTasks.filter(t => {
        const dateField = t.due_time || t.created_at || '';
        const inRange = inDateRange(dateField, start, end);
        const inName = !name || String(t.title || '').toLowerCase().includes(name);
        const inStatus = taskStatus === 'all' || t.status === taskStatus;
        const inPriority = taskPriority === 'all' || t.priority === taskPriority;
        const inModule = taskModule === 'all' || t.module === taskModule;
        return inRange && inName && inStatus && inPriority && inModule;
      });

      const logs = allLifelog.filter(e => {
        if (e._parseError) return false;
        const inRange = inDateRange(e.timestamp || '', start, end);
        const inName = !name || String(e.description || '').toLowerCase().includes(name);
        return inRange && inName;
      });

      renderTasks(tasks);
      renderLifelog(logs);
    }

    async function loadTasks() {
      try {
        const res = await fetch('../tasks/tasks.jsonl');
        if (!res.ok) throw new Error('tasks.jsonl not found');
        const text = await res.text();
        allTasks = parseJsonl(text);
        applyFilters();
        statusEl.textContent = '已载入任务文件：workspace/tasks/tasks.jsonl';
      } catch (e) {
        statusEl.textContent = '无法自动读取任务文件，请通过本地服务器打开（如 python -m http.server）。';
      }
    }

    function formatDatePath(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return { yyyy, mm, dd };
    }

    async function loadLifelogByDate(date) {
      const { yyyy, mm, dd } = formatDatePath(date);
      const path = `../lifelog/${yyyy}/${mm}/${dd}.jsonl`;
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error('lifelog not found');
        const text = await res.text();
        allLifelog = parseJsonl(text);
        applyFilters();
        statusEl.textContent = `已载入 lifelog：${yyyy}-${mm}-${dd}`;
      } catch (e) {
        allLifelog = [];
        applyFilters();
        statusEl.textContent = `未找到 lifelog：${yyyy}-${mm}-${dd}`;
      }
    }

    document.getElementById('applyFilter').addEventListener('click', () => {
      currentPage = 1;
      applyFilters();
    });

    const dateInput = document.getElementById('lifelogDate');
    const btn = document.getElementById('loadLifelogBtn');

    btn.addEventListener('click', async () => {
      if (!dateInput.value) return;
      const date = new Date(dateInput.value + 'T00:00:00');
      await loadLifelogByDate(date);
    });

    const notice = document.getElementById('corsNotice');
    if (location.protocol === 'file:') {
      notice.style.display = 'block';
      notice.innerHTML = '检测到 file:// 打开方式，浏览器会阻止读取本地文件。请在 workspace 目录启动本地服务：<br><code>python -m http.server 8000</code><br>然后打开 <code>http://localhost:8000/tools/jsonl_viewer.html</code>。';
    }

    // Realtime filter
    document.getElementById('nameFilter').addEventListener('input', () => { currentPage = 1; applyFilters(); });
    document.getElementById('taskStatus').addEventListener('change', () => { currentPage = 1; applyFilters(); });
    document.getElementById('taskPriority').addEventListener('change', () => { currentPage = 1; applyFilters(); });
    document.getElementById('taskModule').addEventListener('change', () => { currentPage = 1; applyFilters(); });
    document.getElementById('dateStart').addEventListener('change', () => { currentPage = 1; applyFilters(); });
    document.getElementById('dateEnd').addEventListener('change', () => { currentPage = 1; applyFilters(); });

    document.getElementById('prevPage').addEventListener('click', () => {
      currentPage = Math.max(1, currentPage - 1);
      applyFilters();
    });
    document.getElementById('nextPage').addEventListener('click', () => {
      currentPage += 1;
      applyFilters();
    });

    const today = new Date();
    dateInput.value = today.toISOString().slice(0, 10);
    loadTasks();
    loadLifelogByDate(today);
  </script>
</body>
</html>
