<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeKernel JSONL Viewer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color: #222; }
    h1 { margin-bottom: 8px; }
    .row { display: flex; gap: 20px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 12px; min-width: 260px; background: #fafafa; }
    .section { margin-top: 20px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eee; margin-right: 6px; font-size: 12px; }
    .list { display: grid; gap: 10px; }
    .muted { color: #666; font-size: 12px; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h1>LifeKernel JSONL Viewer</h1>
  <div class="muted">选择 JSONL 文件后即可在浏览器中查看（本页面不会上传数据）。</div>

  <div class="section">
    <div class="row">
      <div>
        <div><strong>任务文件</strong>（workspace/tasks/tasks.jsonl）</div>
        <input type="file" id="tasksFile" accept=".jsonl,.txt" />
      </div>
      <div>
        <div><strong>Lifelog 文件</strong>（workspace/lifelog/YYYY/MM/DD.jsonl）</div>
        <input type="file" id="lifelogFile" accept=".jsonl,.txt" multiple />
      </div>
    </div>
  </div>

  <div id="status" class="section muted"></div>

  <div class="section">
    <h2>任务概览</h2>
    <div id="taskSummary" class="row"></div>
    <div class="section">
      <h3>未完成任务</h3>
      <div id="taskList" class="list"></div>
    </div>
  </div>

  <div class="section">
    <h2>Lifelog</h2>
    <div id="lifelogList" class="list"></div>
  </div>

  <script>
    function parseJsonl(text) {
      return text.split(/\r?\n/).filter(Boolean).map(line => {
        try { return JSON.parse(line); } catch (e) { return { _parseError: true, raw: line }; }
      });
    }

    function renderTasks(tasks) {
      const pending = tasks.filter(t => t.status !== 'done');
      pending.sort((a, b) => (a.due_time || '').localeCompare(b.due_time || ''));
      const done = tasks.filter(t => t.status === 'done');

      const summary = document.getElementById('taskSummary');
      summary.innerHTML = '';
      summary.appendChild(makeCard('总数', String(tasks.length)));
      summary.appendChild(makeCard('未完成', String(pending.length)));
      summary.appendChild(makeCard('已完成', String(done.length)));

      const list = document.getElementById('taskList');
      list.innerHTML = '';
      if (pending.length === 0) {
        list.innerHTML = '<div class="muted">暂无未完成任务</div>';
        return;
      }
      for (const t of pending) {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div><strong>[${t.module || 'work'}]</strong> ${t.title || ''}</div>
          <div class="muted">Status: ${t.status || 'pending'} | Priority: ${t.priority || 'medium'} | Due: ${t.due_time || '-'}</div>
          <div>${t.details || ''}</div>
        `;
        list.appendChild(el);
      }
    }

    function renderLifelog(entries) {
      const list = document.getElementById('lifelogList');
      list.innerHTML = '';
      if (entries.length === 0) {
        list.innerHTML = '<div class="muted">暂无 lifelog</div>';
        return;
      }
      for (const e of entries) {
        const el = document.createElement('div');
        el.className = 'card';
        if (e._parseError) {
          el.innerHTML = `<div class="error">解析失败：${e.raw}</div>`;
        } else {
          el.innerHTML = `
            <div><strong>${e.timestamp || ''}</strong> <span class="pill">${e.module || 'work'}</span> <span class="pill">${e.status || ''}</span></div>
            <div>${e.description || ''}</div>
            <div class="muted">${(e.related_files || []).join(', ')}</div>
          `;
        }
        list.appendChild(el);
      }
    }

    function makeCard(title, value) {
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `<div class="muted">${title}</div><div style="font-size:20px;">${value}</div>`;
      return el;
    }

    const statusEl = document.getElementById('status');

    document.getElementById('tasksFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      const items = parseJsonl(text);
      renderTasks(items);
      statusEl.textContent = `已载入任务文件：${file.name}`;
    });

    document.getElementById('lifelogFile').addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      if (files.length === 0) return;
      let all = [];
      for (const file of files) {
        const text = await file.text();
        all = all.concat(parseJsonl(text));
      }
      renderLifelog(all);
      statusEl.textContent = '已载入 ' + files.length + ' 个 lifelog 文件';
    });
  </script>
</body>
</html>
