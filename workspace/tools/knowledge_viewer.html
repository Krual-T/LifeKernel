<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeKernel Knowledge</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #2563eb;
      --border: #e5e7eb;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 8px; }
    .muted { color: var(--muted); font-size: 12px; }
    .toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin: 12px 0 18px; }
    .search { flex: 1 1 320px; }
    input[type=text] { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; }
    .list { display: grid; gap: 12px; }
    .card { border: 1px solid var(--border); border-radius: 12px; padding: 14px; background: var(--card); box-shadow: var(--shadow); }
    .title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
    .meta { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; font-size: 12px; color: var(--muted); }
    .tag { background: #eef2ff; color: #3730a3; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .kv { margin-top: 8px; display: grid; gap: 6px; }
    .kv-row { display: grid; grid-template-columns: 90px 1fr; gap: 10px; }
    .kv-key { color: var(--muted); font-size: 12px; }
    .mono { font-family: Consolas, "Courier New", monospace; font-size: 12px; }
    .empty { padding: 16px; border: 1px dashed var(--border); border-radius: 10px; background: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Knowledge</h1>
    <div class="muted">知识卡片（JSONL），用于可视化与检索。</div>

    <div class="toolbar">
      <div class="search">
        <input id="searchInput" type="text" placeholder="搜索标题/标签/内容" />
      </div>
      <div id="status" class="muted"></div>
    </div>

    <div id="list" class="list"></div>
  </div>

  <script>
    function parseJsonl(text) {
      return text.split(/\r?\n/).filter(Boolean).map(line => {
        try { return JSON.parse(line); } catch (e) { return { _parseError: true, raw: line }; }
      });
    }

    function getKnowledgeBase() {
      const path = location.pathname || '';
      const root = path.includes('/workspace/') ? '/workspace/' : '/';
      return `${root}knowledge/knowledge.jsonl`;
    }

    function formatDate(value) {
      if (!value) return '';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return value;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${min}`;
    }

    function toText(val) {
      if (!val) return '';
      if (Array.isArray(val)) return val.join(', ');
      return String(val);
    }

    function render(list) {
      const el = document.getElementById('list');
      el.innerHTML = '';
      if (!list.length) {
        el.innerHTML = '<div class="empty muted">暂无知识卡片。</div>';
        return;
      }
      for (const item of list) {
        const card = document.createElement('div');
        card.className = 'card';
        const tags = Array.isArray(item.tags) ? item.tags : [];
        card.innerHTML = `
          <div class="title">${item.title || '(未命名)'} </div>
          <div class="meta">
            <span class="mono">${formatDate(item.timestamp)}</span>
            ${tags.map(t => `<span class=\"tag\">${t}</span>`).join('')}
          </div>
          <div class="kv">
            ${item.problem ? `<div class=\"kv-row\"><div class=\"kv-key\">问题</div><div>${item.problem}</div></div>` : ''}
            ${item.symptom ? `<div class=\"kv-row\"><div class=\"kv-key\">现象</div><div>${item.symptom}</div></div>` : ''}
            ${item.root_cause ? `<div class=\"kv-row\"><div class=\"kv-key\">根因</div><div>${item.root_cause}</div></div>` : ''}
            ${item.solution ? `<div class=\"kv-row\"><div class=\"kv-key\">解决方案</div><div>${item.solution}</div></div>` : ''}
            ${item.environment ? `<div class=\"kv-row\"><div class=\"kv-key\">环境</div><div>${item.environment}</div></div>` : ''}
            ${item.examples ? `<div class=\"kv-row\"><div class=\"kv-key\">示例</div><div>${toText(item.examples)}</div></div>` : ''}
          </div>
        `;
        el.appendChild(card);
      }
    }

    let allItems = [];

    function applyFilter() {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      if (!q) {
        render(allItems);
        return;
      }
      const filtered = allItems.filter(item => {
        const blob = JSON.stringify(item).toLowerCase();
        return blob.includes(q);
      });
      render(filtered);
    }

    async function load() {
      const status = document.getElementById('status');
      try {
        const res = await fetch(getKnowledgeBase());
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const items = parseJsonl(text).filter(i => !i._parseError);
        items.sort((a, b) => (Date.parse(b.timestamp || '') || 0) - (Date.parse(a.timestamp || '') || 0));
        allItems = items;
        status.textContent = `已加载 ${items.length} 条`;
        render(items);
      } catch (e) {
        status.textContent = '无法读取 knowledge.jsonl。请使用 Live Server。';
        render([]);
      }
    }

    document.getElementById('searchInput').addEventListener('input', applyFilter);
    load();
  </script>
</body>
</html>
